<!-- {% extends "base.html" %} -->

{% block content %}

<div class="row">
	<div class="col col-md-10">
		<div id="view_slide"></div>
	</div>
	<div class="col col-md-2">
	    <div class="row">
    	
		    <h5>Slide details</h5>
		    
			Image ID: {{ image_id }} </br>
			<!-- Image directory: {{ image_dir }} </br> -->
			Image name: {{ file_name }} </br>
		
		
			<h5>Annotation controls</h5>
			<br/></br>
			<button type="button" id="reset_button" class="btn btn-warning">Reset annotations</button></br>
			<br/>
			<button type="button" id="save_button" class="btn btn-success">Save annotations&nbsp;</button></br>
			<br/></br>
			<p>
				<div class="btn-group" role="group" aria-label="...">
					<button type="button" id="prev_button" class="btn btn-default">Previous</button>
					<button type="button" id="next_button" class="btn btn-default">Next&nbsp;&nbsp;</button>
				</div>
			</p>
			
		</div>
	</div>
</div>


<script type="text/javascript" src="static/jquery.js"></script>
<script type="text/javascript" src="static/openseadragon/openseadragon.js"></script>
<script type="text/javascript" src="static/openseadragon/openseadragon-scalebar.js"></script>
<script type="text/javascript" src="static/openseadragon-annotations/dist/openseadragon-annotations.js"></script>
<script type="text/javascript">

	$(document).ready(function() {

	    var dzi_data = {{ dzi_data|default('{}')|safe }};
	    var viewer = new OpenSeadragon({
	        id: "view_slide",
	        prefixUrl: "static/openseadragon/images/",
	        timeout: 120000,
	        animationTime: 0.75,
	        blendTime: 0.1,
	        constrainDuringPan: true,
	        maxZoomPixelRatio: 2,
	        minZoomLevel: 1,
	        visibilityRatio: 1,
	        zoomPerScroll: 2,

	    });
	    viewer.addHandler("open", function() {
	        // To improve load times, ignore the lowest-resolution Deep Zoom
	        // levels.  This is a hack: we can't configure the minLevel via
	        // OpenSeadragon configuration options when the viewer is created
	        // from DZI XML.
	        viewer.source.minLevel = 8;
	    });
	    viewer.scalebar({
	        xOffset: 10,
	        yOffset: 10,
	        barThickness: 3,
	        color: '#555555',
	        fontColor: '#333333',
	        backgroundColor: 'rgba(255, 255, 255, 0.5)',
	    });

	    function open_slide(url, mpp) {
	        var tile_source;
	        if (dzi_data[url]) {
	            // DZI XML provided as template argument (deepzoom_tile.py)
	            tile_source = new OpenSeadragon.DziTileSource(
	                    OpenSeadragon.DziTileSource.prototype.configure(
	                    OpenSeadragon.parseXml(dzi_data[url]), url));
	        } else {
	            // DZI XML fetched from server (deepzoom_server.py)
	            tile_source = url;
	        }
	        viewer.open(tile_source);
	        viewer.scalebar({
	            pixelsPerMeter: mpp ? (1e6 / mpp) : 0,
	        });
	        
	        viewer.initializeAnnotations();
	    }

	    open_slide("{{ slide_url }}", parseFloat('{{ slide_mpp }}'));
	    $(".load-slide").click(function(ev) {
	        $(".current-slide").removeClass("current-slide");
	        $(this).parent().addClass("current-slide");
	        open_slide($(this).attr('data-url'),
	                parseFloat($(this).attr('data-mpp')));
	        ev.preventDefault();
	    });

     	// Handlers for button actions
		$( "#reset_button" ).click(function() {
  			console.log( "Handler for .reset_button called." );
  			viewer.annotations.clean();
		});

		$( "#save_button" ).click(function() {
  			console.log( "Handler for .save_button called." );
  			var annotations = viewer.annotations.get();
  			console.log(annotations);

  			for (var i = 0; i < annotations.length; i++) {
  				if (i % 2 == 1) {
  					// Odd
  					var path_data = annotations[i][1]['d'];
  					console.log(i);
  					console.log(path_data); // The SVG coordinates to send back to server.
  				}
  			}

  			// Get the SVG viewbox coordinates.
  			var view_height = $("div#view_slide").height();
  			var view_width = $("div#view_slide").width();
  			console.log(view_height + ", " + view_width);
		});

		$( "#prev_button" ).click(function() {
  			console.log( "Handler for .prev_button called." );
		});
		$( "#next_button" ).click(function() {
  			console.log( "Handler for .next_button called." );
		});
	});

</script>


{% endblock %}

